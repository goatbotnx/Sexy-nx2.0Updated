const axios = require("axios");
const fs = require("fs-extra");
const path = require("path");

module.exports = {
  config: {
    name: "poli",
    version: "18.0",
    author: "xalman",
    role: 0,
    shortDescription: "Ultra Fast AI Image",
    category: "ai"
  },

  onStart: async function ({ api, event, args }) {
    if (!args[0]) return api.sendMessage("тЪая╕П ржкрзНрж░ржорзНржкржЯ ржжрж┐ржи! ржЙржжрж╛рж╣рж░ржг: /poli a glowing neon dragon", event.threadID);

    const prompt = args.join(" ");
    const cacheDir = path.join(__dirname, "cache");
    const imgPath = path.join(cacheDir, `sd_${event.messageID}.png`);

    try {
      if (!fs.existsSync(cacheDir)) fs.mkdirSync(cacheDir);

      api.sendMessage("тЪб ржкрзНрж░рзЛ-рж▓рзЗржнрзЗрж▓рзЗрж░ ржЫржмрж┐ рждрзИрж░рж┐ рж╣ржЪрзНржЫрзЗ, ржПржХржЯрзБ ржзрж░рзЗржи...", event.threadID);

      // ржПржЯрж┐ ржПржХржЯрж┐ ржкрж╛ржУрзЯрж╛рж░ржлрзБрж▓ ржЕрж▓рзНржЯрж╛рж░ржирзЗржЯрж┐ржн API ржпрж╛ ржжрзНрж░рзБржд рж░рзЗрж╕ржкржирзНрж╕ ржжрзЗрзЯ
      const response = await axios.get(`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?model=flux-realism&width=1024&height=1024&nologo=true`, { 
        responseType: "arraybuffer",
        timeout: 30000 
      });

      // ржирзЛржЯ: ржпржжрж┐ ржЙржкрж░рзЗрж░ржЯрж╛ ржирж╛ ржЪрж▓рзЗ, ржирж┐ржЪрзЗрж░ API ржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рзЗржи (ржХржорзЗржирзНржЯ ржЖржЙржЯ ржХрж░рж╛ ржЖржЫрзЗ)
      // const response = await axios.get(`https://api.airforce/v1/desktop/upscale?prompt=${encodeURIComponent(prompt)}`, { responseType: "arraybuffer" });

      await fs.writeFile(imgPath, response.data);

      return api.sendMessage(
        {
          body: `ЁЯФе ржЖржкржирж╛рж░ рж╣рж╛ржЗ-ржХрзЛрзЯрж╛рж▓рж┐ржЯрж┐ ржЫржмрж┐ рж░рзЗржбрж┐!\n\nPrompt: ${prompt}`,
          attachment: fs.createReadStream(imgPath)
        },
        event.threadID,
        () => { if (fs.existsSync(imgPath)) fs.unlinkSync(imgPath); },
        event.messageID
      );

    } catch (err) {
      console.error(err);
      // ржмрзНржпрж╛ржХржЖржк API (Heroku/Vercel рж╣рзЛрж╕рзНржЯ ржХрж░рж╛ рж▓рж╛рж░рзНржЬ ржоржбрзЗрж▓)
      try {
        const backupRes = await axios.get(`https://api.vyturex.com/sdxl?prompt=${encodeURIComponent(prompt)}`, { responseType: "arraybuffer" });
        await fs.writeFile(imgPath, backupRes.data);
        return api.sendMessage({ attachment: fs.createReadStream(imgPath) }, event.threadID, () => fs.unlinkSync(imgPath));
      } catch (e) {
        api.sendMessage("тЭМ рж╕ржмржЧрзБрж▓рж╛ рж╕рж╛рж░рзНржнрж╛рж░ржЗ ржПржЦржи ржмрж┐ржЬрж┐, ржкрж░рзЗ ржЯрзНрж░рж╛ржЗ ржХрж░рзЗржи ржнрж╛ржЗред", event.threadID);
      }
    }
  }
};
